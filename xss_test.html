
<html>

    <script>
        
        function report(xss_detail_element) {
            console.log('WARNING! EVAL ELEMENT .. '+xss_detail_element.tagName+'  '+xss_detail_element.src);
        }
        
        function dynamic_check_eval_event(element) {
            var black_element_event=['onerror','onload'];
            
            for (var element_attribute_index in element) {
                var event=eval('element.'+element_attribute_index);
                
                for (var black_element_event_index in black_element_event)
                    if (black_element_event[black_element_event_index]==element_attribute_index && 'function'==typeof event) 
                        return true;
            }
            return false;
        }
        
        function dynamic_check_eval_element(element) {
            var black_element_name=['SCRIPT','IFRAME'];
            
            for (var index in black_element_name)
                if (black_element_name[index]==element.tagName)
                    return true;
            
            return false;
        }
        
        function init() {
            //  init body observer object for monited dynamic element create ..
            var observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if ('childList'==mutation.type || 'subtree'==mutation.type) {
                        for (var index=0;index<mutation.addedNodes.length;++index) {
                            var new_element=mutation.addedNodes[index];
                            
                            if (dynamic_check_eval_event(new_element) || dynamic_check_eval_element(new_element))
                                report(new_element);
                        }
                    } else if ('attributes'==mutation.type) {
                        var new_attribute_value=eval('mutation.target.'+mutation.attributeName);
                        var change_attribute_element=mutation.target;
                        
                        if (dynamic_check_eval_event(change_attribute_element))
                            report(change_attribute_element);
                    }
                }); 
            });

            observer.observe(document.body,{
                'childList': true,
                'subtree': true,
                'attributes' : true
            });
            
            //  
            
            //  build element on body ..
            test_case();
        }
        
        function test_case() {
            /*
            var img=document.createElement('img');
            img.src='http://www.baidu.com/';
            img.onerror='alert("xss");';
            document.body.appendChild(img);
            */
            
            var test_script='<img src="http://www.baidu.com/" onerror="alert(\'img on error xss\');" />';
            test_script+='<img src="https://ss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/img/logo/logo_white.png" />';
            test_script+='<img>';
            test_script+='<img src="https://ss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/img/logo_top_ca79a146.png" onload="alert(\'img onload  xss\');" />';
            test_script+='<script>alert("script xss");';
            test_script+='</script';
            test_script+='>';
            test_script+='<nb>';
            test_script+='</nb>';
            
            document.body.innerHTML=test_script;
            
//            document.body.innerHTML+='
//    /*<script>';
            /*
            img.onerror='alert("xasd");';
            img.alt='trd';
    
            var script=document.createElement('script');
            document.body.appendChild(script);
            */
        }
        
    </script>
   
    <body onload="init()">
       
       <div id="xss_test_1"><!-- 反射XSS ,直接插入 <script> -->
           
       </div>
       <div id="xss_test_2"><!-- 反射XSS ,直接插入 <img> -->
           
       </div>
       <div id="xss_test_3"><!-- 反射XSS ,直接插入 <iframe> -->
           
       </div>
       <div id="xss_test_4"><!-- 反射XSS ,混合插入 <script> -->
           
       </div>
       <div id="xss_test_5"><!-- 反射XSS ,混合属性和事件属性插入 <img> -->
           
       </div>
       <div id="xss_test_6"><!-- 反射XSS ,<img> 中混合属性和事件属性插入 <script> -->
           
       </div>
       <div id="xss_test_7"><!-- 反射XSS ,混合元素插入 -->
           
       </div>
       
       <div id="xss_test_8"><!-- 储存XSS ,直接插入 <script> -->
           
       </div>
        
    </body>

</html>




























